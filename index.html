<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>圖書管理系統</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-8">圖書管理系統</h1>

      <!-- 新增書籍按鈕 -->
      <button
        onclick="openModal()"
        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-6"
      >
        新增書籍
      </button>

      <!-- 書籍列表 -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                書名
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                作者
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                ISBN
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                出版日期
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                狀態
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                操作
              </th>
            </tr>
          </thead>
          <tbody id="bookList" class="bg-white divide-y divide-gray-200">
            <!-- 書籍資料會在這裡動態插入 -->
          </tbody>
        </table>
      </div>

      <!-- Modal 表單 -->
      <div
        id="modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
      >
        <div
          class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
        >
          <div class="mt-3">
            <h3
              class="text-lg leading-6 font-medium text-gray-900 mb-4"
              id="modalTitle"
            >
              新增書籍
            </h3>
            <form id="bookForm">
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2"
                  >書名</label
                >
                <input
                  type="text"
                  id="title"
                  name="title"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2"
                  >作者</label
                >
                <input
                  type="text"
                  id="author"
                  name="author"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2"
                  >ISBN</label
                >
                <input
                  type="text"
                  id="isbn"
                  name="isbn"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2"
                  >出版日期</label
                >
                <input
                  type="date"
                  id="publication_date"
                  name="publication_date"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                />
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2"
                  >狀態</label
                >
                <select
                  id="status"
                  name="status"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                  <option value="available">可借閱</option>
                  <option value="borrowed">已借出</option>
                  <option value="maintenance">維護中</option>
                </select>
              </div>
              <div class="flex items-center justify-between">
                <button
                  type="submit"
                  class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                  儲存
                </button>
                <button
                  type="button"
                  onclick="closeModal()"
                  class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API 配置
      const API_BASE_URL = "http://localhost:8000/api";
      let currentBookId = null;

      // 初始化頁面
      document.addEventListener("DOMContentLoaded", () => {
        loadBooks();
        setupFormSubmission();
      });

      // 載入書籍列表
      async function loadBooks() {
        try {
          const response = await axios.get(`${API_BASE_URL}/books/`);
          renderBooks(response.data);
        } catch (error) {
          console.error("Error loading books:", error);
          alert("載入書籍資料失敗");
        }
      }

      // 渲染書籍列表
      function renderBooks(books) {
        const bookList = document.getElementById("bookList");
        bookList.innerHTML = books
          .map(
            (book) => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${book.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${book.author}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${book.isbn}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${
                      book.publication_date
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap">${getStatusDisplay(
                      book.status
                    )}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editBook(${
                          book.id
                        })" class="text-blue-600 hover:text-blue-900 mr-3">編輯</button>
                        <button onclick="deleteBook(${
                          book.id
                        })" class="text-red-600 hover:text-red-900">刪除</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // 設置表單提交處理
      function setupFormSubmission() {
        document.getElementById("bookForm").onsubmit = async (e) => {
          e.preventDefault();
          const formData = getFormData();
          try {
            if (currentBookId) {
              await axios.put(
                `${API_BASE_URL}/books/${currentBookId}/`,
                formData
              );
            } else {
              await axios.post(`${API_BASE_URL}/books/`, formData);
            }
            closeModal();
            loadBooks();
          } catch (error) {
            console.error("Error saving book:", error);
            alert("儲存失敗");
          }
        };
      }

      // 打開 Modal
      function openModal(bookId = null) {
        currentBookId = bookId;
        document.getElementById("modal").classList.remove("hidden");
        document.getElementById("modalTitle").textContent = bookId
          ? "編輯書籍"
          : "新增書籍";
        if (!bookId) {
          document.getElementById("bookForm").reset();
        }
      }

      // 關閉 Modal
      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
        currentBookId = null;
      }

      // 編輯書籍
      async function editBook(id) {
        try {
          const response = await axios.get(`${API_BASE_URL}/books/${id}/`);
          const book = response.data;
          fillFormData(book);
          openModal(id);
        } catch (error) {
          console.error("Error loading book:", error);
          alert("載入書籍資料失敗");
        }
      }

      // 刪除書籍
      async function deleteBook(id) {
        if (confirm("確定要刪除這本書嗎？")) {
          try {
            await axios.delete(`${API_BASE_URL}/books/${id}/`);
            loadBooks();
          } catch (error) {
            console.error("Error deleting book:", error);
            alert("刪除失敗");
          }
        }
      }

      // 取得表單資料
      function getFormData() {
        return {
          title: document.getElementById("title").value,
          author: document.getElementById("author").value,
          isbn: document.getElementById("isbn").value,
          publication_date: document.getElementById("publication_date").value,
          status: document.getElementById("status").value,
        };
      }

      // 填充表單資料
      function fillFormData(book) {
        document.getElementById("title").value = book.title;
        document.getElementById("author").value = book.author;
        document.getElementById("isbn").value = book.isbn;
        document.getElementById("publication_date").value =
          book.publication_date;
        document.getElementById("status").value = book.status;
      }

      // 獲取狀態顯示文字
      function getStatusDisplay(status) {
        const statusMap = {
          available: "可借閱",
          borrowed: "已借出",
          maintenance: "維護中",
        };
        return statusMap[status] || status;
      }
    </script>
  </body>
</html>
